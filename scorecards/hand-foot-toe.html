<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hand-Foot-Toe Scorecard</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="A scorecard app for tracking Hand, Foot & Toe card game scores">
    <meta name="theme-color" content="#6366f1">
    <link rel="manifest" href="../manifest.json">

    <!-- Apple PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Open-Scorecard">
    <link rel="apple-touch-icon" href="../icons/icon-192x192.png">

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="192x192" href="../icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="../icons/icon-512x512.png">

    <!-- Shared Styles -->
    <link rel="stylesheet" href="../shared/common.css">
    <style>
        /* Scorecard-specific styles */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .controls-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }

        .team-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .team-names {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .team-input-group {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .team-names input {
            padding: 10px 15px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 1em;
            width: 150px;
        }

        .remove-team-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .remove-team-btn:hover {
            background: #c82333;
            transform: scale(1.05);
        }

        .add-team-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .add-team-btn:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }

        .reset-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .reset-btn:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
        }

        .content {
            padding: 30px;
        }

        .hand-section {
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }

        .hand-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            font-size: 1.3em;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            transition: background 0.3s;
        }

        .hand-header:hover {
            background: linear-gradient(135deg, #7689f1 0%, #8356b3 100%);
        }

        .hand-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .collapse-icon {
            font-size: 0.8em;
            transition: transform 0.3s;
        }

        .hand-section.collapsed .collapse-icon {
            transform: rotate(-90deg);
        }

        .hand-total {
            font-size: 0.9em;
            opacity: 0.95;
        }

        .hand-body {
            padding: 15px;
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
        }

        .hand-section.collapsed .hand-body {
            max-height: 0;
            padding: 0 15px;
        }

        .teams-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .card-separator {
            margin: 15px 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #667eea, transparent);
            opacity: 0.3;
        }

        .team-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            border: 2px solid #e9ecef;
        }

        .team-card-header {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #667eea;
            color: #667eea;
            text-align: center;
        }

        .score-row {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .score-label {
            font-size: 0.9em;
            font-weight: 600;
            color: #495057;
        }

        .score-input-group {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .score-input {
            width: 60px;
            padding: 8px 4px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            font-size: 1em;
            text-align: center;
            transition: border-color 0.3s;
        }

        .score-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .score-input.points {
            background: #e7f3ff;
            font-weight: bold;
            color: #0066cc;
            border: 2px solid #b3d9ff;
            width: 90px;
        }

        .score-label-with-tooltip {
            position: relative;
            display: inline-flex;
            align-items: center;
            cursor: help;
        }

        .tooltip {
            visibility: hidden;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 0;
            background-color: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 20px;
            border: 5px solid transparent;
            border-top-color: #333;
        }

        .score-label-with-tooltip:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        .increment-btn {
            width: 32px;
            height: 32px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 5px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            line-height: 1;
        }

        .increment-btn:hover {
            background: #667eea;
            color: white;
            transform: scale(1.05);
        }

        .increment-btn:active {
            transform: scale(0.95);
        }

        .increment-btn.decrement {
            border-color: #dc3545;
            color: #dc3545;
        }

        .increment-btn.decrement:hover {
            background: #dc3545;
            color: white;
        }

        .team-total-display {
            margin-top: 15px;
            padding-top: 12px;
            border-top: 2px solid #dee2e6;
            text-align: center;
            font-weight: bold;
            color: #667eea;
            font-size: 1.1em;
        }

        .gone-out-section {
            margin-top: 20px;
            padding: 15px;
            background: #fff8e1;
            border-radius: 8px;
            border: 2px solid #ffd54f;
        }

        .gone-out-section label {
            font-weight: bold;
            margin-right: 15px;
            color: #f57c00;
        }

        .gone-out-section select {
            padding: 8px 15px;
            border: 2px solid #ffd54f;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
            background: white;
        }

        .score-game-section {
            margin-top: 30px;
            padding: 25px;
            text-align: center;
        }

        .score-game-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 18px 50px;
            border-radius: 12px;
            font-size: 1.3em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .score-game-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .score-game-btn:active {
            transform: translateY(-1px);
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 2em;
            color: #666;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #f0f0f0;
            color: #333;
        }

        .winner-announcement {
            text-align: center;
            margin-bottom: 30px;
        }

        .winner-trophy {
            font-size: 4em;
            margin-bottom: 10px;
        }

        .winner-title {
            font-size: 2em;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .winner-name {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .winner-score {
            font-size: 1.5em;
            color: #666;
        }

        .scores-divider {
            height: 2px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 30px 0;
        }

        .final-scores-title {
            font-size: 1.5em;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }

        .score-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .score-item.first {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-left-width: 6px;
        }

        .score-item-rank {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
            margin-right: 15px;
        }

        .score-item-name {
            flex: 1;
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
        }

        .score-item-score {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .header p {
                font-size: 0.95em;
            }

            .teams-container {
                grid-template-columns: 1fr;
            }

            .winner-trophy {
                font-size: 3em;
            }

            .winner-name {
                font-size: 2em;
            }

            .winner-score {
                font-size: 1.2em;
            }

            .modal-content {
                padding: 30px 20px;
            }

            .score-game-btn {
                font-size: 1.1em;
                padding: 15px 40px;
            }

            .team-names {
                width: 100%;
            }

            .team-names input {
                flex: 1;
                min-width: 0;
            }

            .controls {
                padding: 15px;
            }

            .content {
                padding: 15px;
            }

            .hand-body {
                padding: 10px;
            }

            .score-input {
                width: 50px;
                padding: 6px 2px;
                font-size: 0.95em;
            }

            .score-input.points {
                width: 80px;
            }

            .increment-btn {
                width: 28px;
                height: 28px;
                font-size: 1em;
            }

            .tooltip {
                font-size: 0.75em;
                padding: 6px 10px;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .teams-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1025px) {
            .teams-container {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <a href="../index.html" class="back-home">Home</a>
    <div class="container">
        <div class="header">
            <h1>üÉè Hand-Foot-Toe Scorecard</h1>
            <p>Track your game scores with ease</p>
        </div>

        <div class="controls">
            <div class="controls-top">
                <div class="team-controls">
                    <button class="add-team-btn" onclick="addTeam()">‚ûï Add Team</button>
                </div>
                <button class="reset-btn" onclick="resetScorecard()">üîÑ Reset Scorecard</button>
            </div>
            <div class="team-names" id="teamNamesContainer">
                <!-- Team inputs will be dynamically generated -->
            </div>
        </div>

        <div class="content" id="handsContainer">
            <!-- Hands will be dynamically generated here -->
        </div>

        <div class="score-game-section">
            <button class="score-game-btn" onclick="showGameResults()">üèÜ Score Game</button>
        </div>
    </div>

    <!-- Modal for game results -->
    <div class="modal-overlay" id="gameResultsModal" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="closeModal()">&times;</button>

            <div class="winner-announcement">
                <div class="winner-trophy">üèÜ</div>
                <div class="winner-title">Winner!</div>
                <div class="winner-name" id="winnerName">Team Name</div>
                <div class="winner-score" id="winnerScore">0 points</div>
            </div>

            <div class="scores-divider"></div>

            <div class="final-scores-title">Final Scores</div>
            <div class="score-list" id="scoreList">
                <!-- Scores will be dynamically generated -->
            </div>
        </div>
    </div>

    <script>
        // Scoring constants
        const POINTS = {
            CLEAN_BOOK: 500,
            DIRTY_BOOK: 300,
            BOOK_OF_SEVENS: 5000,
            BOOK_OF_FIVES: 3000,
            BOOK_OF_WILDS: 2500,
            FIRST_OUT: 200,
            RED_THREE_IN_BOOK: 100,
            RED_THREE_IN_HAND: -500,
            BLACK_THREE_IN_HAND: -100
        };

        const NUM_HANDS = 4;
        let teams = [
            { id: 1, name: 'Team 1' },
            { id: 2, name: 'Team 2' },
            { id: 3, name: 'Team 3' }
        ];
        let nextTeamId = 4;
        const STORAGE_KEY = 'handFootToeScorecard';

        // Save data to localStorage
        function saveData() {
            try {
                const data = {
                    teams: teams.map(team => ({
                        id: team.id,
                        name: document.getElementById(`team${team.id}Name`)?.value || team.name
                    })),
                    hands: {}
                };

                // Save all hand data
                for (let hand = 1; hand <= NUM_HANDS; hand++) {
                    data.hands[hand] = {};

                    teams.forEach(team => {
                        const categories = ['sevens', 'fives', 'wilds', 'clean', 'dirty', 'redThreesInBooks', 'redThreesInHand', 'blackThreesInHand', 'cardPoints', 'deductions'];
                        data.hands[hand][team.id] = {};

                        categories.forEach(category => {
                            const elem = document.getElementById(`hand${hand}_${category}_${team.id}`);
                            data.hands[hand][team.id][category] = elem?.value || '0';
                        });
                    });

                    data.hands[hand].goneOut = document.getElementById(`goneOut${hand}`)?.value || '';
                }

                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                console.log('Data saved to localStorage:', data);
            } catch (e) {
                console.error('Error saving data:', e);
            }
        }

        // Load data from localStorage
        function loadData() {
            const savedData = localStorage.getItem(STORAGE_KEY);
            console.log('Loading from localStorage:', savedData);

            if (!savedData) {
                console.log('No saved data found');
                return false;
            }

            try {
                const data = JSON.parse(savedData);
                console.log('Parsed data:', data);

                // Restore teams
                if (data.teams && data.teams.length > 0) {
                    teams = data.teams;
                    nextTeamId = Math.max(...teams.map(t => t.id)) + 1;
                    console.log('Restored teams:', teams);
                }

                // Render team inputs
                renderTeamInputs();

                // Rebuild scorecard with correct teams
                const container = document.getElementById('handsContainer');
                container.innerHTML = '';
                for (let hand = 1; hand <= NUM_HANDS; hand++) {
                    container.appendChild(createHandSection(hand));
                }

                // Restore all hand data
                for (let hand = 1; hand <= NUM_HANDS; hand++) {
                    if (data.hands && data.hands[hand]) {
                        const handData = data.hands[hand];

                        teams.forEach(team => {
                            if (handData[team.id]) {
                                const categories = ['sevens', 'fives', 'wilds', 'clean', 'dirty', 'redThreesInBooks', 'redThreesInHand', 'blackThreesInHand', 'cardPoints', 'deductions'];
                                categories.forEach(category => {
                                    const elem = document.getElementById(`hand${hand}_${category}_${team.id}`);
                                    if (elem && handData[team.id][category] !== undefined) {
                                        elem.value = handData[team.id][category];
                                    }
                                });
                            }
                        });

                        // Restore gone out
                        const goneOutElem = document.getElementById(`goneOut${hand}`);
                        if (goneOutElem && handData.goneOut) {
                            goneOutElem.value = handData.goneOut;
                        }
                    }
                }

                updateAllTotals();
                console.log('Data loaded successfully');
                return true;
            } catch (e) {
                console.error('Error loading saved data:', e);
                return false;
            }
        }

        // Render team input fields
        function renderTeamInputs() {
            const container = document.getElementById('teamNamesContainer');
            container.innerHTML = '';

            teams.forEach(team => {
                const inputGroup = document.createElement('div');
                inputGroup.className = 'team-input-group';
                inputGroup.innerHTML = `
                    <input type="text"
                           id="team${team.id}Name"
                           value="${team.name}"
                           placeholder="Team ${team.id} Name"
                           oninput="updateTeamName(${team.id})">
                    ${teams.length > 1 ? `<button class="remove-team-btn" onclick="removeTeam(${team.id})">‚úï</button>` : ''}
                `;
                container.appendChild(inputGroup);
            });
        }

        // Add a new team
        function addTeam() {
            const newTeam = {
                id: nextTeamId++,
                name: `Team ${teams.length + 1}`
            };
            teams.push(newTeam);
            renderTeamInputs();
            rebuildScorecard();
            saveData();
        }

        // Remove a team
        function removeTeam(teamId) {
            if (teams.length <= 1) {
                alert('You must have at least one team!');
                return;
            }

            if (confirm('Are you sure you want to remove this team? All their scores will be lost.')) {
                teams = teams.filter(t => t.id !== teamId);
                renderTeamInputs();
                rebuildScorecard();
                saveData();
            }
        }

        // Update a team name
        function updateTeamName(teamId) {
            const input = document.getElementById(`team${teamId}Name`);
            const team = teams.find(t => t.id === teamId);
            if (team && input) {
                team.name = input.value || `Team ${teamId}`;
                updateTeamLabels();
                saveData();
            }
        }

        // Initialize the scorecard
        function initializeScorecard() {
            // Try to load saved data first
            const dataLoaded = loadData();

            // If no saved data, build from defaults
            if (!dataLoaded) {
                renderTeamInputs();
                rebuildScorecard();
                updateAllTotals();
            }
        }

        // Rebuild all hands and totals
        function rebuildScorecard() {
            const container = document.getElementById('handsContainer');
            container.innerHTML = '';

            for (let hand = 1; hand <= NUM_HANDS; hand++) {
                container.appendChild(createHandSection(hand));
            }

            updateAllTotals();
        }

        // Create a hand section
        function createHandSection(handNum) {
            const section = document.createElement('div');
            section.className = 'hand-section';
            section.id = `hand-section-${handNum}`;

            const teamCards = teams.map(team => createTeamCard(handNum, team.id, team.name)).join('');
            const goneOutOptions = teams.map(team =>
                `<option value="${team.id}">${team.name}</option>`
            ).join('');

            section.innerHTML = `
                <div class="hand-header" onclick="toggleHandCollapse(${handNum})">
                    <div class="hand-header-left">
                        <span class="collapse-icon">‚ñº</span>
                        <span>Hand ${handNum}</span>
                    </div>
                    <span class="hand-total" id="handTotal${handNum}"></span>
                </div>
                <div class="hand-body">
                    <div class="teams-container">
                        ${teamCards}
                    </div>

                    <div class="gone-out-section">
                        <label for="goneOut${handNum}">üèÜ Team Gone Out First:</label>
                        <select id="goneOut${handNum}" onchange="updateHandTotal(${handNum})">
                            <option value="">None</option>
                            ${goneOutOptions}
                        </select>
                    </div>
                </div>
            `;
            return section;
        }

        // Toggle hand collapse/expand
        function toggleHandCollapse(handNum) {
            const section = document.getElementById(`hand-section-${handNum}`);
            if (section) {
                section.classList.toggle('collapsed');
            }
        }

        // Create a team card for a hand
        function createTeamCard(hand, teamId, teamName) {
            const createBookRow = (label, category, tooltip) => `
                <div class="score-row">
                    <div class="score-label-with-tooltip">
                        <div class="score-label">${label}</div>
                        <div class="tooltip">${tooltip}</div>
                    </div>
                    <div class="score-input-group">
                        <button class="increment-btn decrement" onclick="adjustValue('hand${hand}_${category}_${teamId}', -1, ${hand})" type="button">‚àí</button>
                        <input type="number"
                               id="hand${hand}_${category}_${teamId}"
                               class="score-input"
                               value="0"
                               min="0"
                               step="1"
                               pattern="[0-9]*"
                               inputmode="numeric"
                               onkeydown="allowOnlyNumbers(event)"
                               onpaste="validateNumericPaste(event)"
                               oninput="updateHandTotal(${hand})">
                        <button class="increment-btn" onclick="adjustValue('hand${hand}_${category}_${teamId}', 1, ${hand})" type="button">+</button>
                    </div>
                </div>
            `;

            const createPointsRow = (label, category, tooltip) => `
                <div class="score-row">
                    <div class="score-label-with-tooltip">
                        <div class="score-label">${label}</div>
                        <div class="tooltip">${tooltip}</div>
                    </div>
                    <input type="number"
                           id="hand${hand}_${category}_${teamId}"
                           class="score-input points"
                           value="0"
                           min="0"
                           step="1"
                           pattern="[0-9]*"
                           inputmode="numeric"
                           onkeydown="allowOnlyNumbers(event)"
                           onpaste="validateNumericPaste(event)"
                           oninput="updateHandTotal(${hand})">
                </div>
            `;

            return `
                <div class="team-card">
                    <div class="team-card-header" id="header${teamId}-${hand}">${teamName}</div>

                    ${createBookRow("7's Books", 'sevens', 'Book of seven 7s ‚Ä¢ 5,000 points')}
                    ${createBookRow("5's Books", 'fives', 'Book of seven 5s ‚Ä¢ 3,000 points')}
                    ${createBookRow("Wilds Books", 'wilds', '7 wild cards (Jokers or 2s) ‚Ä¢ 2,500 points')}
                    ${createBookRow("Clean Books", 'clean', '7 natural cards (no wilds) ‚Ä¢ 500 points')}
                    ${createBookRow("Dirty Books", 'dirty', '7 cards with wilds ‚Ä¢ 300 points')}

                    <div class="card-separator"></div>

                    ${createBookRow("Red 3's in Books", 'redThreesInBooks', 'Red 3s played in books ‚Ä¢ +100 points each')}
                    ${createBookRow("Red 3's in Hand", 'redThreesInHand', 'Red 3s left in hand ‚Ä¢ -500 points each')}
                    ${createBookRow("Black 3's in Hand", 'blackThreesInHand', 'Black 3s left in hand ‚Ä¢ -100 points each')}

                    <div class="card-separator"></div>

                    ${createPointsRow("Card Points", 'cardPoints', 'Total point value of all cards played')}
                    ${createPointsRow("Card Deductions", 'deductions', 'Point value of cards left in hand (subtract)')}

                    <div class="team-total-display" id="teamTotal${hand}_${teamId}">Total: 0</div>
                </div>
            `;
        }

        // Only allow numeric input
        function allowOnlyNumbers(event) {
            // Allow: backspace, delete, tab, escape, enter
            if ([8, 9, 27, 13, 46].indexOf(event.keyCode) !== -1 ||
                // Allow: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
                (event.keyCode === 65 && event.ctrlKey === true) ||
                (event.keyCode === 67 && event.ctrlKey === true) ||
                (event.keyCode === 86 && event.ctrlKey === true) ||
                (event.keyCode === 88 && event.ctrlKey === true) ||
                // Allow: home, end, left, right
                (event.keyCode >= 35 && event.keyCode <= 39)) {
                return;
            }
            // Ensure that it is a number and stop the keypress
            if ((event.shiftKey || (event.keyCode < 48 || event.keyCode > 57)) && (event.keyCode < 96 || event.keyCode > 105)) {
                event.preventDefault();
            }
        }

        // Validate input on paste
        function validateNumericPaste(event) {
            const pasteData = (event.clipboardData || window.clipboardData).getData('text');
            if (!/^\d+$/.test(pasteData)) {
                event.preventDefault();
            }
        }

        // Adjust value using +/- buttons
        function adjustValue(elementId, delta, hand) {
            const elem = document.getElementById(elementId);
            if (!elem) return;

            const currentValue = parseInt(elem.value) || 0;
            const newValue = Math.max(0, currentValue + delta);
            elem.value = newValue;
            updateHandTotal(hand);
        }

        // Calculate points for a specific booking type
        function calculateBookingPoints(hand, type, team) {
            const count = parseInt(document.getElementById(`hand${hand}_${type}_${team}`)?.value) || 0;
            let points = 0;

            switch(type) {
                case 'sevens':
                    points = count * POINTS.BOOK_OF_SEVENS;
                    break;
                case 'fives':
                    points = count * POINTS.BOOK_OF_FIVES;
                    break;
                case 'wilds':
                    points = count * POINTS.BOOK_OF_WILDS;
                    break;
                case 'clean':
                    points = count * POINTS.CLEAN_BOOK;
                    break;
                case 'dirty':
                    points = count * POINTS.DIRTY_BOOK;
                    break;
                case 'redThreesInBooks':
                    points = count * POINTS.RED_THREE_IN_BOOK;
                    break;
                case 'redThreesInHand':
                    points = count * POINTS.RED_THREE_IN_HAND;
                    break;
                case 'blackThreesInHand':
                    points = count * POINTS.BLACK_THREE_IN_HAND;
                    break;
            }

            return points;
        }

        // Update totals for a specific hand
        function updateHandTotal(hand) {
            const totals = {};

            teams.forEach(team => {
                let total = 0;

                // Calculate booking points
                total += calculateBookingPoints(hand, 'sevens', team.id);
                total += calculateBookingPoints(hand, 'fives', team.id);
                total += calculateBookingPoints(hand, 'wilds', team.id);
                total += calculateBookingPoints(hand, 'clean', team.id);
                total += calculateBookingPoints(hand, 'dirty', team.id);

                // Calculate Red and Black 3's points
                total += calculateBookingPoints(hand, 'redThreesInBooks', team.id);
                total += calculateBookingPoints(hand, 'redThreesInHand', team.id);
                total += calculateBookingPoints(hand, 'blackThreesInHand', team.id);

                // Add card points
                const cardPoints = parseInt(document.getElementById(`hand${hand}_cardPoints_${team.id}`)?.value) || 0;
                total += cardPoints;

                // Subtract deductions
                const deductions = parseInt(document.getElementById(`hand${hand}_deductions_${team.id}`)?.value) || 0;
                total -= deductions;

                // Add first out bonus
                const goneOut = document.getElementById(`goneOut${hand}`)?.value;
                if (goneOut == team.id) {
                    total += POINTS.FIRST_OUT;
                }

                totals[team.id] = total;

                // Update individual team total display in card
                const teamTotalElem = document.getElementById(`teamTotal${hand}_${team.id}`);
                if (teamTotalElem) {
                    teamTotalElem.textContent = `Total: ${total.toLocaleString()}`;
                }
            });

            // Update hand total display
            const handTotalElem = document.getElementById(`handTotal${hand}`);
            if (handTotalElem) {
                const totalText = teams.map(team => totals[team.id].toLocaleString()).join(' / ');
                handTotalElem.textContent = `Total: ${totalText}`;
            }

            saveData();
        }

        // Calculate grand totals for all teams
        function calculateGrandTotals() {
            const grandTotals = {};

            teams.forEach(team => {
                grandTotals[team.id] = 0;

                for (let hand = 1; hand <= NUM_HANDS; hand++) {
                    let handTotal = 0;

                    // Calculate booking points
                    handTotal += calculateBookingPoints(hand, 'sevens', team.id);
                    handTotal += calculateBookingPoints(hand, 'fives', team.id);
                    handTotal += calculateBookingPoints(hand, 'wilds', team.id);
                    handTotal += calculateBookingPoints(hand, 'clean', team.id);
                    handTotal += calculateBookingPoints(hand, 'dirty', team.id);

                    // Calculate Red and Black 3's points
                    handTotal += calculateBookingPoints(hand, 'redThreesInBooks', team.id);
                    handTotal += calculateBookingPoints(hand, 'redThreesInHand', team.id);
                    handTotal += calculateBookingPoints(hand, 'blackThreesInHand', team.id);

                    // Add card points
                    const cardPoints = parseInt(document.getElementById(`hand${hand}_cardPoints_${team.id}`)?.value) || 0;
                    handTotal += cardPoints;

                    // Subtract deductions
                    const deductions = parseInt(document.getElementById(`hand${hand}_deductions_${team.id}`)?.value) || 0;
                    handTotal -= deductions;

                    // Add first out bonus
                    const goneOut = document.getElementById(`goneOut${hand}`)?.value;
                    if (goneOut == team.id) {
                        handTotal += POINTS.FIRST_OUT;
                    }

                    grandTotals[team.id] += handTotal;
                }
            });

            return grandTotals;
        }

        // Show game results modal
        function showGameResults() {
            const totals = calculateGrandTotals();

            // Create sorted list of teams with scores
            const sortedTeams = teams.map(team => ({
                id: team.id,
                name: team.name,
                score: totals[team.id]
            })).sort((a, b) => b.score - a.score);

            // Display winner
            const winner = sortedTeams[0];
            document.getElementById('winnerName').textContent = winner.name;
            document.getElementById('winnerScore').textContent = `${winner.score.toLocaleString()} points`;

            // Display all scores ranked
            const scoreList = document.getElementById('scoreList');
            scoreList.innerHTML = sortedTeams.map((team, index) => `
                <div class="score-item ${index === 0 ? 'first' : ''}">
                    <div class="score-item-rank">#${index + 1}</div>
                    <div class="score-item-name">${team.name}</div>
                    <div class="score-item-score">${team.score.toLocaleString()}</div>
                </div>
            `).join('');

            // Show modal
            document.getElementById('gameResultsModal').classList.add('active');
        }

        // Close modal
        function closeModal(event) {
            if (!event || event.target.classList.contains('modal-overlay') || event.target.classList.contains('modal-close')) {
                document.getElementById('gameResultsModal').classList.remove('active');
            }
        }

        // Update all totals
        function updateAllTotals() {
            for (let hand = 1; hand <= NUM_HANDS; hand++) {
                updateHandTotal(hand);
            }
        }

        // Reset the entire scorecard
        function resetScorecard() {
            if (confirm('Are you sure you want to reset the entire scorecard? This cannot be undone.')) {
                localStorage.removeItem(STORAGE_KEY);
                teams = [
                    { id: 1, name: 'Team 1' },
                    { id: 2, name: 'Team 2' },
                    { id: 3, name: 'Team 3' }
                ];
                nextTeamId = 4;
                initializeScorecard();
            }
        }

        // Update team labels across all sections
        function updateTeamLabels() {
            teams.forEach(team => {
                // Update headers in hands
                for (let hand = 1; hand <= NUM_HANDS; hand++) {
                    const headerElem = document.getElementById(`header${team.id}-${hand}`);
                    if (headerElem) {
                        headerElem.textContent = team.name;
                    }

                    // Update gone out options
                    const select = document.getElementById(`goneOut${hand}`);
                    if (select) {
                        const option = Array.from(select.options).find(opt => opt.value == team.id);
                        if (option) {
                            option.text = team.name;
                        }
                    }
                }
            });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeScorecard();
        });
    </script>

    <!-- Service Worker Registration -->
    <script src="../shared/pwa.js"></script>
</body>
</html>
